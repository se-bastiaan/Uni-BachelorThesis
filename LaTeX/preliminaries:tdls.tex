\section{Tunneled Direct-Link Setup}\label{tdls}

\iffalse
- TDLS
	- 802.11
	- PeerKey
\fi

\subsection{General}

Tunneled Direct-Link Setup (TDLS) is a part of the IEEE 802.11 specification\cite{80211} that allows two devices to create a direct connection. This specification is more commonly known as Wi-Fi and allows devices to establish a wireless local area network.

A 802.11 network exists of one or more stations (STAs). A usual setup has one station that operates as access point (AP). All other stations connect to that AP and use it as the gateway for their data. TDLS allows stations connected to the AP to simultaneously set up a direct link between two stations. This reduces the amount of traffic transferred via the access point and avoids congestion inside that access point.

\subsection{Establishing a direct-link}
\label{sec:establishing-tdls}

To establish a direct-link we need two stations. One of the stations is called the \emph{initiator}, the other is the \emph{responder}. The messages they use to manage their connection are shown in figure \ref{fig:establishment-mcs}. The first message in the exchange to establish a new link is send through the access point by the initiator to the responder, who proposes a direct-link based on similar capabilities of the two stations. The responder replies through the access point either with a status code indicating success or failure in the setup response. The receival of this message is then confirmed by the last message in this part of the exchange. If any of the two stations wants to sever the direct link they can do this by sending a teardown message. This teardown message can both be send through the access point or directly to the receiving station.

\begin{figure}[!h]
	\centering
	\includegraphics[height=200pt]{estmcs}
	\caption{The TDLS direct-link establishment}
	\label{fig:establishment-mcs}
\end{figure}

\subsection{TDLS PeerKey}
\label{sec:tdls-peerkey}

A direct link connection can be secured via the TDLS PeerKey (TPK). This key is is used to provide a Robust Secure Network Associaton (RSNA) for the direct link. This provides data origin authenticity of the setup messages and the confidentiality for data that will be send over the direct link.

The TPK is computed using fields from the messages in the TDLS establishment. Next, theses TPK can be used to calculate the Message Integrity Code (MIC) of the messages sent in the establishment.

The fields used in the calculation of the TPK are two nonces (SNonce and ANonce) and the MAC addresses of the initiator, responder and access point. The handshake (figure \ref{fig:tpk-mcs}) is started by the initiator who sends a chosen cipher suite (RSNE) and the SNonce to the responder station. The responder will use its own nonce to generate the TPK. This TPK is then used to calculate the MIC with the whole message as input. The initiator, who is now receiving both the nonces and a calculated MIC will derive the TPK as well and confirm that the MIC is valid. The responder will then send the 3rd message containing a new MIC to validate the direct link.

\begin{figure}[!h]
	\centering
	\includegraphics[height=140pt]{tpkmcs}
	\caption{The TPK Handshake}
	\label{fig:tpk-mcs}
\end{figure}