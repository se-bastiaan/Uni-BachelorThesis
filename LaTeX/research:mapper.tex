\section{Mapper}

As previously mentioned StateLearner requires a mapper to send and receive messages to the TDLS implementation. First we'll explore two tools used in our mapper: Scapy and pycrypto. Then we will look how these tools are used in our mapper.

\subsection{Scapy}

Scapy \footnote{https://github.com/secdev/scapy} is a Python program that allows you to capture, manipulate and send network packets. This open source library was used to create the 802.11 TDLS packets and wrap them inside ethernet frames. Scapy itself has support for the basic 802.11 packets that are part of the specification. The 802.11 specification actually identifies packets as a piece of base information, the action that should be executed and so-called elements that can differ based on the action requested. Scapy implements packets that could be used for the normal 4-way handshake, but it does not implement any TDLS messages.
This means that we implemented the complete messages used for TDLS from scratch using the building blocks that Scapy provides. This includes the Setup Request, Setup Response, Setup Confirm and Teardown messages that we previously discussed in section \ref{sec:establishing-tdls}.

\subsection{Cryptographic utilities}

The construction of TDLS messages involves cryptographic operations. These operations, hashing algorithm SHA256 and the AES encryption algorithm are not natively implemented in Python itself, therefore we need an external implementation. The solution we're using for our research is the Python Cryptography Toolkit \footnote{https://github.com/dlitz/pycrypto} or pycrypto for short. This toolkit, also open-source, implements multiple secure hash functions and various encryption algorithms and it has been used in this type of research before \cite{Vanhoef:2017,Veldhuizen:2017}.

\subsection{Implementation}

The implementation of the mapper was written in Python to make use of the previously mentioned tools. It exposes a socket connection to the learner to enable communication between the mapper and the learner. The input symbols determined by the learner are sent over the socket and transcribed into the right TDLS messages. These messages are then send on the network interface of the learner side in the network.
The side of the teacher gets the time to answer and the mapper will subsequently translate the answer to the right output symbols. The output symbol will then be send back to the learner and the mapper will be made ready for the next input symbol. Since it is not possible to check if a TDLS connection is made the mapper assumes a successful connection and disconnection after a correct handshake and a sent teardown respectively. The initialisation of a new connection will also assume a disconnect, as per the specification. If the mapper receives a setup response message from the implementation the contents of the message will be saved in the mapper. This message contains the ANonce, SNonce, BSSID and MAC addresses needed to create the right TPK for the connection. That TPK is used if the next message by the learner is a setup confirm message. Any other symbol from the learner will reset these values.